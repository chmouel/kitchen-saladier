=================
Development setup
=================

Setup Keystone service
----------------------

The Saladier is using Keystone for authentication so you would need to deploy
one for your development setup. This is done through the use of a minimal
Devstack with just the Keystone service, here are the steps:

.. code-block:: bash

   $ git clone https://github.com/openstack-dev/devstack.git
   $ cd devstack
   $ cat <<EOF>localrc

     ENABLED_SERVICES=key,mysql

     DATABASE_PASSWORD=password
     SERVICE_TOKEN=password
     SERVICE_PASSWORD=password
     ADMIN_PASSWORD=password
     EOF
   $ stack.sh

We now have a devstack with Keystone running, say it runs on 192.168.122.5 for
this example (it should be another address in your configuration).

Installing the Saladier
-----------------------

First we install the Saladier for development purpose:

.. code-block:: bash

   $ python setup.py develop

Configuring the Saladier
------------------------

To configure the Saladier we need to edit its configuration file:

.. code-block:: bash

   $ cd saladier
   $ cat <<EOF>etc/saladier/saladier.conf.sample

     [DEFAULT]
     debug = True

     [api]
     api_paste_config=etc/saladier/api_paste.ini

     [keystone_authtoken]
     signing_dir = /tmp/saladier-signing-dir
     admin_tenant_name = service
     admin_password = ADMIN
     admin_user = admin
     identity_uri = http://192.168.122.5:35357
     EOF

Launch the Saladier API server
------------------------------

To launch the server api, you can use the saladier-api command:

.. code-block:: bash

   $ saladier-api --config-file etc/saladier/saladier.conf.sample

The saladier will now be running on http://localhost:8777  by default.

Before starting to send requests to the saladier, we need to generate a
keystone token.

You first need to install the keystone client:

.. code-block:: bash

   $ pip install python-keystoneclient

The OS_* environment variables should be set as described in OpenStack
documentation, cf. http://docs.openstack.org/user-guide/content/cli_openrc.html

.. code-block:: bash

   $ export OS_AUTH_URL=http://192.168.122.5:5000/v2.0/
   $ export OS_USERNAME=admin
   $ export OS_PASSWORD=password
   $ export OS_TENANT_NAME=demo

You can get a token in the TOKEN variable with this one-liner:

.. code-block:: bash

   $ TOKEN=$(keystone token-get| grep ' id'| cut -d'|' -f 3| tr -d '[:space:]')

Or just copy it from the output of 'keystone token-get'

Now you can use it to query the saladier to whatever URL.

.. code-block:: bash

   $ curl -H "x-auth-token: $TOKEN" http://localhost:8777/

You development setup is done ! Congratulations :) !

Unit Testing
------------

The unit tests is by default using to the SQLite database so you don't
need to have a mysql database running locally.

You can run your test against a MySQL or PostgreSQL database. To do so, you
need to adjust the `SALADIER_DATABASE_TEST_CONNECTION` variable.

- MySQL

    .. code-block:: bash

        $ SALADIER_DATABASE_TEST_CONNECTION="mysql+pymysql://saladier:password@127.0.0.1/saladier" tox

- PostgreSQL

    .. code-block:: bash

        $ export SALADIER_DATABASE_TEST_CONNECTION="postgres://postgres:password@127.0.0.1/saladier" tox

.. note:: The `saladier` database must exist.


Functional Testing
==================

Functional tests are inside the directory `saladier_integrationtests` using
their own config files generated by tox target `genconfig` (default sample
is located in `etc/saladier/saladier_integration.conf.sample`).

Assuming your sample file is configured properly you can point the
environement variable

`export SALADIER_INTEG_CONF=yourconfigfile`

to point to your config file so this can be used,

You can run the test directly with ::

 tox -eintegration

There is a `fig` target for it to get your all setup automatically which is
run with a saladier connected to a `MySQL` database ::

  fig -efunctional

Integration tests CI with saladierclient
----------------------------------------

By default `saladierclient` repository gets updated automatically in our CI to
master for integration tests.

Since sometime you are developing a patch that needs some non merged review of
saladierclient, the `CI` is reading the git log looking for a tag in the last
commit log called `SaladierClient-Review:`, for example if you have ::

  SaladierClient-Review: 1777

the CI would check out review number 1777 (with `git-review -d`) to test the
integration test with.

Note that this dependence only work when the repository has already been
checked out, if it wasn't you need to run a second pass (with the ``recheck``
magic keyword in gerrit for example after the first pass has completed).

Create your developer environment like a boss
---------------------------------------------

We have added a docker based container for our CI to make things very
easy. We have as well added a run_tests.sh to make it easy to launch those,
This is the manual steps that the run_tests.sh script is doing

- Install docker on your laptop, for example on fedora::

    yum -y install docker-io graphviz

- Install `fig` with ::

    pip install -U fig

- Go to `tools/containers` inside the saladier repository and just type::

    fig run unittests

This will setup a MySQL and PostgreSQL and mount your saladier code as volume
to launch the unittests. The first time should take a bit of time to construct
the images but after that it should quick as the light :)

.. note:: The functional tests are only run against Python 2. The unit tests
   are run on both (2.7 and 3.4).
